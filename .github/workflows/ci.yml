name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    name: Tests (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11"]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      - name: Install package
        run: |
          pip install --upgrade setuptools wheel
          pip install -e .
          pip install pytest

      - name: Regression check
        run: python -c "import autotunenet; print(autotunenet.__file__)"

      - name: Inspect site-packages
        run: |
          python - <<EOF
          import site, os
          for p in site.getsitepackages():
            print("Listing:", p)
            if os.path.exists(os.path.join(p, "autotunenet")):
                print("FOUND autotunenet package")
            else:
                print("NO autotunenet package")
          EOF
      
      - name: Debug filesystem
        run: |
          ls -R src/autotunenet
        
      - name: Debug install
        run: |
          pip show autotunenet || true
          python - <<EOF
          import sys
          import autotunenet
          print("autotunenet:", autotunenet)
          print("file:", autotunenet.__file__)
          print("sys.path:")
          for p in sys.path:
            print(p)
          EOF 

      - name: Run tests
        run: python -m pytest -v